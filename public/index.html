<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="Web site created using create-react-app" />
  <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
  <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
  <!-- titlecl -->
  <title>React App</title>
  <!-- css template -->
  <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css">
  <link href="assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="assets/css/owl.carousel.css">
  <link rel="stylesheet" type="text/css" href="assets/css/owl.theme.default.css">
  <link rel="stylesheet" type="text/css" href="assets/css/animate.css">
  <link rel="stylesheet" type="text/css" href="assets/css/main_styles.css">
  <link rel="stylesheet" type="text/css" href="assets/css/responsive.css">
  <link rel="stylesheet" type="text/css" href="assets/css/new.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <!-- js template -->
  <script src="assets/js/jquery-3.2.1.min.js"></script>
  <script src="assets/js/popper.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>
  <script src="assets/js/isotope.pkgd.min.js"></script>
  <script src="assets/js/owl.carousel.js"></script>
  <script src="assets/js/easing.js"></script>
  <script src="assets/js/custom.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>
  <script>
    var CORSProxy = "https://cors-hld.herokuapp.com/";
    var activeArticle = 0;
    var totalArticle = 7;

    var xDown = null;
    var yDown = null;

    function trimString(string, maxLength) {
      if (string.length > maxLength) {
        string = string.substring(0, maxLength);
        string = string.substr(0, Math.min(string.length, string.lastIndexOf(" ")));
        string += "[...]";
      }
      return string;
    }

    function replaceText(original, before, after) {
      if (before.constructor !== Array) {
        before = [before];
        after = [after];
      }
      var result = original;
      for (var i = 0; i < before.length; i++) {
        result = result.split(before[i]).join(after[i]);
      }
      return result;
    }

    function fetchImage(url, i) {
      $.ajax({
        url: CORSProxy + url,
        type: 'GET'
      }).done(function (html) {
        var image = $(html).find(".image-wrapper").first().html();
        image = $(image).attr("src").replace("7x5", "420x300");

        $("#articles li").eq(i).find(".card-image").css("background-image", "url(" + image + ")");
      })
    }

    function fetchFeed(url) {
      $.ajax({
        url: CORSProxy + url,
        type: 'GET',
        dataType: "xml",
        error: function (xhr, ajaxOptions, thrownError) {
          //$("#articles").append("<li class='error'><h2>Can't Fetch News :/</h2></li>");
          //$("#articles").css("max-height","100px");
          generateCards($("#backup").html(), false);
          $(".limit-error").addClass("show");
        },
        success: function (xml) {
          generateCards(xml, true);
        }
      })
    }

    function generateHtml(data) {
      var html = $("#article-template").html();
      var before = ["{{category}}", "{{title}}", "{{pubDate}}", "{{description}}", "{{url}}", "{{z-index}}"];

      return replaceText(html, before, data);
    }

    function generateCards(xml, isCDATA) {
      var items = $(xml).find('item');
      for (var i = 0; i < totalArticle; i++) {
        var url = $(items[i]).find('link').text();
        var title = $(items[i]).find('title').text();
        title = trimString(title, 65);
        var description = $(items[i]).find('description').text();

        if (!isCDATA)
          description = $(items[i]).find('description').html();

        var pubDate = new Date($(items[i]).find('pubDate').text());
        pubDate = moment(pubDate).fromNow();


        var category = $(items[i]).find('category').last().text().toLowerCase();
        var html = generateHtml([category, title, pubDate, description, url, (i * -2)]);

        $("#articles").append(html);
        fetchImage(url, i);
      }
      $("#articles").css("max-height", "600px");
      arrangeCards();

      $("#articles li").click(function () {
        $(this).find(".card-content").toggleClass("open");
        if ($(this).find(".card-content").hasClass("open")) {
          $("#articles li").eq(activeArticle).find("a").removeAttr("tabindex");
        }
      })

      $('#articles li').keypress(function (e) {
        var key = e.which;
        if (key == 13)  // the enter key code
        {
          $(this).find(".card-content").toggleClass("open");
          if ($(this).find(".card-content").hasClass("open")) {
            $("#articles li").eq(activeArticle).find("a").removeAttr("tabindex");
          }
          else {
            $("#articles li").eq(activeArticle).find("a").attr("tabindex", -1);
          }
          return false;
        }
      });

      $(".card-content a").click(function (e) {
        e.stopPropagation();
      })
    }

    function arrangeCards() {
      var order = 0;
      for (var i = activeArticle; i < totalArticle; i++) {
        $("#articles li").removeAttr("tabindex");
        $("#articles li").eq(i).css("transform", "translate3d(0px, 0px, " + order * -50 + "px) rotateX(0deg)");
        order++;
      }
      $("#articles .card-content").removeClass("open");
      $("#articles li").eq(activeArticle).attr("tabindex", 0);
      $("#articles li").eq(activeArticle).find("a").attr("tabindex", -1);
      $("#articles li").eq(activeArticle).find(".open a").removeAttr("tabindex");
    }

    function nextCard() {
      if (activeArticle < totalArticle - 1) {
        $("nav button").removeAttr("disabled");
        $("#articles li").eq(activeArticle).addClass("go-away");
        activeArticle++;
        arrangeCards();

        if (activeArticle == totalArticle - 1)
          $(".next-article").attr("disabled", "");
      }
    }

    function prevCard() {
      if (activeArticle > 0) {
        $("nav button").removeAttr("disabled");
        activeArticle--;
        $("#articles li").eq(activeArticle).removeClass("go-away");
        arrangeCards();

        if (activeArticle == 0)
          $(".prev-article").attr("disabled", "");
      }
    }

    //swiping functions (from https://stackoverflow.com/questions/2264072/detect-a-finger-swipe-through-javascript-on-the-iphone-and-android)
    function handleTouchStart(evt) {
      xDown = evt.touches[0].clientX;
      yDown = evt.touches[0].clientY;
    };

    function handleTouchMove(evt) {
      if (!xDown || !yDown) {
        return;
      }

      var xUp = evt.touches[0].clientX;
      var yUp = evt.touches[0].clientY;

      var xDiff = xDown - xUp;
      var yDiff = yDown - yUp;

      if (Math.abs(xDiff) > Math.abs(yDiff)) {
        if (xDiff > 0) {
          nextCard();
        } else {
          prevCard();
        }
      }
      xDown = null;
      yDown = null;
    };

    $(function () {
      fetchFeed("https://www.soompi.com/fanclub/bts/feed/");

      $(".prev-article").click(function () {
        prevCard();
      })
      $(".next-article").click(function () {
        nextCard();
      })

      //navigate with arrow keyboard
      $(document).keydown(function (e) {
        switch (e.which) {
          case 37: // left
            prevCard();
            break;

          case 38: // up
            prevCard();
            break;

          case 39: // right
            nextCard();
            break;

          case 40: // down
            nextCard();
            break;

          default: return;
        }
        e.preventDefault();
      });

      //swipe listener
      document.getElementById("articles").addEventListener('touchstart', handleTouchStart, false);
      document.getElementById("articles").addEventListener('touchmove', handleTouchMove, false);

    })
  </script>
</head>

<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>
  <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
</body>

</html>